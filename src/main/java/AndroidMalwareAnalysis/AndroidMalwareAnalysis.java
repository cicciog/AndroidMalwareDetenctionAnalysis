package AndroidMalwareAnalysis;

import FileManager.FileManager;

import java.io.*;

public class AndroidMalwareAnalysis {

    public static void main (String [] args) throws IOException {
        String urlApkTool = "https://bitbucket.org/iBotPeaches/apktool/downloads/apktool_2.3.3.jar";
        String pathProject = System.getProperty("user.dir");
        String toolsFolder = "work\\tools";
        String apkFolder = "work\\apk";
        String apkREFolder = "work\\apkRE";
        String apkToolName = "apktool.jar";
        String apk = null;
        String apkWithoutExt = null;

        FileManager fileManager = new FileManager();
        BufferedReader console = new BufferedReader(new InputStreamReader(System.in));

        //Creo le directory di lavoro, se necessario
        fileManager.createDirectory(toolsFolder);
        fileManager.createDirectory(apkFolder);
        fileManager.createDirectory(apkREFolder);




        //Scarico i tool necessari
        try {
            fileManager.downloadFile(urlApkTool, toolsFolder + "/" + apkToolName);
        } catch (IOException e) {
            System.out.println("FILE NON SCARICATO");
            e.getStackTrace();
        }

        System.out.println();
        System.out.println();




        //Lista di tutti gli apk da analizzare
        File apkDirectory = new File(apkFolder);
        File [] listOfFiles = apkDirectory.listFiles();

        System.out.println("Scegli l'APK da analizzare:");

        for (int i = 0; i < listOfFiles.length; i++) {
            System.out.println((i+1) + ") " + listOfFiles[i].getName());
        }

        System.out.println();
        System.out.print("APK da analizzare: ");
        int scelta = Integer.valueOf(console.readLine()) - 1;
        System.out.println();




        //Nome apk
        apk = listOfFiles[scelta].getName();
        int pos = apk.lastIndexOf(".");
        if(pos > 0)
            apkWithoutExt = apk.substring(0, pos);
        else
            apkWithoutExt = apk;




        //Decompilazione apk scelto
        System.out.println("DECODING IN CORSO...");
        try {
            fileManager.executeCommand("java -jar " + pathProject + "\\" + toolsFolder + "\\" + apkToolName + " d " +
                    pathProject + "\\" + apkFolder + "\\" + apk + " -o " + pathProject + "\\" + apkREFolder + "\\" +
                    apkWithoutExt);
        } catch (IOException | InterruptedException e) {
            System.out.println("ERRORE: NON E' STATO POSSIBILE DECODIFICARE L'APK");
            System.exit(0);
        }

        System.out.println("OPERAZIONE EFFETTUATA CON SUCCESSO");
        System.out.println();




        //Elimino tutto, ad eccezione di lib, per i file so, di smile, per i file omonimi e del manifest
        File apkREFile = new File(pathProject + "\\" + apkREFolder + "\\" + apkWithoutExt);

        System.out.println("Controllo file e/o cartelle in corso...");
        System.out.println();

        for (int i = 0; i < apkREFile.listFiles().length; i++) {
            File folder = apkREFile.listFiles()[i];

            System.out.println("File o cartella trovata: " + folder.getName());

            if (!folder.getName().equals("AndroidManifest.xml") && !folder.getName().equals("lib") &&
                    !folder.getName().contains("smali")){
                fileManager.deleteFolder(apkREFile.listFiles()[i]);
                i--;
                System.out.println("Eliminata");
            } else {
                System.out.println("Ignorata");
            }

            System.out.println();
        }
    }
}
